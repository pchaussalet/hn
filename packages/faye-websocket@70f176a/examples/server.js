var WebSocket=require("../lib/faye/websocket"),deflate=require("permessage-deflate"),fs=require("fs"),http=require("http"),https=require("https"),port=process.argv[2]||7e3,secure="tls"===process.argv[3],options={extensions:[deflate],ping:5},upgradeHandler=function(e,t,n){var i=new WebSocket(e,t,n,["irc","xmpp"],options);console.log("[open]",i.url,i.version,i.protocol,e.headers),i.pipe(i),i.onclose=function(e){console.log("[close]",e.code,e.reason),i=null}},requestHandler=function(e,t){if(!WebSocket.EventSource.isEventSource(e))return staticHandler(e,t);var n=new WebSocket.EventSource(e,t),i=parseInt(n.lastEventId,10)||0;console.log("[open]",n.url,n.lastEventId);var r=setInterval(function(){i+=1,n.send("Time: "+i),setTimeout(function(){n&&n.send("Update!!",{event:"update",id:i})},1e3)},2e3);fs.createReadStream(__dirname+"/haproxy.conf").pipe(n,{end:!1}),n.onclose=function(){clearInterval(r),console.log("[close]",n.url),n=null}},staticHandler=function(e,t){var n=e.url;fs.readFile(__dirname+n,function(e,n){var i=e?404:200;t.writeHead(i,{"Content-Type":"text/html"}),t.write(n||"Not found"),t.end()})},server=secure?https.createServer({key:fs.readFileSync(__dirname+"/../spec/server.key"),cert:fs.readFileSync(__dirname+"/../spec/server.crt")}):http.createServer();server.on("request",requestHandler),server.on("upgrade",upgradeHandler),server.listen(port);