montageDefine("70f176a","lib/faye/eventsource",{dependencies:["stream","util","websocket-driver","websocket-driver/lib/websocket/driver/headers","./websocket/api","./websocket/api/event_target","./websocket/api/event"],factory:function(e,t,n){var i=e("stream").Stream,r=e("util"),a=e("websocket-driver"),s=e("websocket-driver/lib/websocket/driver/headers"),o=e("./websocket/api"),l=e("./websocket/api/event_target"),c=e("./websocket/api/event"),u=function(e,t,n){this.writable=!0,n=n||{},this._stream=t.socket,this._ping=n.ping||this.DEFAULT_PING,this._retry=n.retry||this.DEFAULT_RETRY;var i=a.isSecureRequest(e)?"https:":"http:";this.url=i+"//"+e.headers.host+e.url,this.lastEventId=e.headers["last-event-id"]||"",this.readyState=o.CONNECTING;var r=new s,l=this;if(n.headers)for(var c in n.headers)r.set(c,n.headers[c]);if(this._stream&&this._stream.writable){process.nextTick(function(){l._open()}),this._stream.setTimeout(0),this._stream.setNoDelay(!0);var u="HTTP/1.1 200 OK\r\nContent-Type: text/event-stream\r\nCache-Control: no-cache, no-store\r\nConnection: close\r\n"+(""+r)+"\r\n"+"retry: "+Math.floor(1e3*this._retry)+"\r\n\r\n";this._write(u),this._stream.on("drain",function(){l.emit("drain")}),this._ping&&(this._pingTimer=setInterval(function(){l.ping()},1e3*this._ping)),["error","end"].forEach(function(e){l._stream.on(e,function(){l.close()})})}};r.inherits(u,i),u.isEventSource=function(e){if("GET"!==e.method)return!1;var t=(e.headers.accept||"").split(/\s*,\s*/);return t.indexOf("text/event-stream")>=0};var h={DEFAULT_PING:10,DEFAULT_RETRY:5,_write:function(e){if(!this.writable)return!1;try{return this._stream.write(e,"utf8")}catch(t){return!1}},_open:function(){if(this.readyState===o.CONNECTING){this.readyState=o.OPEN;var e=new c("open");e.initEvent("open",!1,!1),this.dispatchEvent(e)}},write:function(e){return this.send(e)},end:function(e){void 0!==e&&this.write(e),this.close()},send:function(e,t){if(this.readyState>o.OPEN)return!1;e=(e+"").replace(/(\r\n|\r|\n)/g,"$1data: "),t=t||{};var n="";return t.event&&(n+="event: "+t.event+"\r\n"),t.id&&(n+="id: "+t.id+"\r\n"),n+="data: "+e+"\r\n\r\n",this._write(n)},ping:function(){return this._write(":\r\n\r\n")},close:function(){if(this.readyState>o.OPEN)return!1;this.readyState=o.CLOSED,this.writable=!1,this._pingTimer&&clearInterval(this._pingTimer),this._stream&&this._stream.end();var e=new c("close");return e.initEvent("close",!1,!1),this.dispatchEvent(e),!0}};for(var d in h)u.prototype[d]=h[d];for(var p in l)u.prototype[p]=l[p];n.exports=u}});