montageDefine("70f176a","lib/faye/websocket/api",{dependencies:["stream","util","websocket-driver","./api/event_target","./api/event"],factory:function(e,t,n){var i=e("stream").Stream,r=e("util"),a=e("websocket-driver"),s=e("./api/event_target"),o=e("./api/event"),l=function(e){e=e||{},a.validateOptions(e,["headers","extensions","maxLength","ping","proxy","tls","ca"]),this.readable=this.writable=!0;var t=e.headers;if(t)for(var n in t)this._driver.setHeader(n,t[n]);var i=e.extensions;i&&[].concat(i).forEach(this._driver.addExtension,this._driver),this._ping=e.ping,this._pingId=0,this.readyState=l.CONNECTING,this.bufferedAmount=0,this.protocol="",this.url=this._driver.url,this.version=this._driver.version;var r=this;this._driver.on("open",function(){r._open()}),this._driver.on("message",function(e){r._receiveMessage(e.data)}),this._driver.on("close",function(e){r._beginClose(e.reason,e.code)}),this._driver.on("error",function(e){r._emitError(e.message)}),this.on("error",function(){}),this._driver.messages.on("drain",function(){r.emit("drain")}),this._ping&&(this._pingTimer=setInterval(function(){r._pingId+=1,r.ping(""+r._pingId)},1e3*this._ping)),this._configureStream(),this._proxy||(this._stream.pipe(this._driver.io),this._driver.io.pipe(this._stream))};r.inherits(l,i),l.CONNECTING=0,l.OPEN=1,l.CLOSING=2,l.CLOSED=3;var c={write:function(e){return this.send(e)},end:function(e){void 0!==e&&this.send(e),this.close()},pause:function(){return this._driver.messages.pause()},resume:function(){return this._driver.messages.resume()},send:function(e){return this.readyState>l.OPEN?!1:(e instanceof Buffer||(e+=""),this._driver.messages.write(e))},ping:function(e,t){return this.readyState>l.OPEN?!1:this._driver.ping(e,t)},close:function(){this.readyState!==l.CLOSED&&(this.readyState=l.CLOSING),this._driver.close()},_configureStream:function(){var e=this;this._stream.setTimeout(0),this._stream.setNoDelay(!0),["close","end"].forEach(function(t){this._stream.on(t,function(){e._finalizeClose()})},this),this._stream.on("error",function(t){e._emitError("Network error: "+e.url+": "+t.message),e._finalizeClose()})},_open:function(){if(this.readyState===l.CONNECTING){this.readyState=l.OPEN,this.protocol=this._driver.protocol||"";var e=new o("open");e.initEvent("open",!1,!1),this.dispatchEvent(e)}},_receiveMessage:function(e){if(this.readyState>l.OPEN)return!1;this.readable&&this.emit("data",e);var t=new o("message",{data:e});t.initEvent("message",!1,!1),this.dispatchEvent(t)},_emitError:function(e){if(!(this.readyState>=l.CLOSING)){var t=new o("error",{message:e});t.initEvent("error",!1,!1),this.dispatchEvent(t)}},_beginClose:function(e,t){this.readyState!==l.CLOSED&&(this.readyState=l.CLOSING,this._stream&&(this._stream.end(),this._stream.readable||this._finalizeClose()),this._closeParams=[e,t])},_finalizeClose:function(){if(this.readyState!==l.CLOSED){this.readyState=l.CLOSED,this._pingTimer&&clearInterval(this._pingTimer),this._stream&&this._stream.end(),this.readable&&this.emit("end"),this.readable=this.writable=!1;var e=this._closeParams?this._closeParams[0]:"",t=this._closeParams?this._closeParams[1]:1006,n=new o("close",{code:t,reason:e});n.initEvent("close",!1,!1),this.dispatchEvent(n)}}};for(var u in c)l.prototype[u]=c[u];for(var h in s)l.prototype[h]=s[h];n.exports=l}});