var util=require("util"),net=require("net"),tls=require("tls"),crypto=require("crypto"),url=require("url"),driver=require("websocket-driver"),API=require("./api"),Event=require("./api/event"),DEFAULT_PORTS={"http:":80,"https:":443,"ws:":80,"wss:":443},SECURE_PROTOCOLS=["https:","wss:"],Client=function(e,t,n){n=n||{},this.url=e,this._driver=driver.client(this.url,{maxLength:n.maxLength,protocols:t}),["open","error"].forEach(function(e){this._driver.on(e,function(){u.headers=u._driver.headers,u.statusCode=u._driver.statusCode})},this);var i=n.proxy||{},r=url.parse(i.origin||this.url),a=r.port||DEFAULT_PORTS[r.protocol],s=SECURE_PROTOCOLS.indexOf(r.protocol)>=0,o=function(){u._onConnect()},l=n.tls||{},c=i.origin?i.tls||{}:l,u=this;l.ca=l.ca||n.ca,this._stream=s?tls.connect(a,r.hostname,c,o):net.connect(a,r.hostname,o),i.origin&&this._configureProxy(i,l),API.call(this,n)};util.inherits(Client,API),Client.prototype._onConnect=function(){var e=this._proxy||this._driver;e.start()},Client.prototype._configureProxy=function(e,t){var n,i=url.parse(this.url),r=SECURE_PROTOCOLS.indexOf(i.protocol)>=0,a=this;if(this._proxy=this._driver.proxy(e.origin),e.headers)for(n in e.headers)this._proxy.setHeader(n,e.headers[n]);this._proxy.pipe(this._stream,{end:!1}),this._stream.pipe(this._proxy),this._proxy.on("connect",function(){if(r){var e={socket:a._stream,servername:i.hostname};for(n in t)e[n]=t[n];a._stream=tls.connect(e),a._configureStream()}a._driver.io.pipe(a._stream),a._stream.pipe(a._driver.io),a._driver.start()}),this._proxy.on("error",function(e){a._driver.emit("error",e)})},module.exports=Client;