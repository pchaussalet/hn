var Montage=require("./core").Montage,MessageFormat=require("./messageformat"),logger=require("./logger").logger("localizer"),Serializer=require("./serialization").Serializer,Deserializer=require("./serialization").Deserializer,Promise=require("./promise").Promise,Bindings=require("./bindings").Bindings,PropertyChanges=require("collections/listen/property-changes"),FrbBindings=require("frb/bindings"),stringify=require("frb/stringify"),expand=require("frb/expand"),Scope=require("frb/scope");MessageFormat.locale=require("./messageformat-locale");var KEY_KEY="key",DEFAULT_MESSAGE_KEY="default",LOCALE_STORAGE_KEY="montage_locale",LOCALES_DIRECTORY="locale",MESSAGES_FILENAME="messages",MANIFEST_FILENAME="manifest.json",EMPTY_STRING_FUNCTION=function(){return""},reLanguageTagValidator=/^[a-zA-Z]+(?:-[a-zA-Z0-9]+)*$/,Localizer=exports.Localizer=Montage.specialize({constructor:{value:function Localizer(){this.super()}},init:{value:function(t){return this.locale=t||defaultLocalizer.locale,this}},initWithMessages:{value:function(t,e){return this.locale=t,this.messages=e,this}},messageFormat:{serializable:!1,value:null},_messages:{value:null},messages:{get:function(){return this._messages},set:function(t){if(this._messages!==t){if(null!=t&&"object"!=typeof t)throw new TypeError(t," is not an object");this._messages=t}}},messagesPromise:{serializable:!1,value:null},_locale:{value:null},locale:{get:function(){return this._locale},set:function(t){if(!reLanguageTagValidator.test(t))throw new TypeError("Language tag '"+t+"' is not valid. It must match http://tools.ietf.org/html/rfc5646 (alphanumeric characters separated by hyphens)");this._locale!==t&&(this._locale=t,this.messageFormat=new MessageFormat(t))}},_availableLocales:{value:null},availableLocales:{get:function(){return this._availableLocales?this._availableLocales:this._availableLocales=this._manifest.get("files").get(LOCALES_DIRECTORY).get("files").then(function(t){return Object.keys(t)})}},_require:{value:self.mr},require:{serializable:!1,get:function(){return this._require},set:function(t){this._require!==t&&(this.__manifest=null,this._require=t)}},__manifest:{value:null},_manifest:{depends:["require"],get:function(){var t=this.require;return t.packageDescription.manifest===!0?this.__manifest?this.__manifest:this.__manifest=t.async(MANIFEST_FILENAME):Promise.reject(Error("Package has no manifest. "+t.location+'package.json must contain "manifest": true and '+t.location+MANIFEST_FILENAME+" must exist"))}},loadMessages:{value:function(t,e){if(!this.require)throw Error("Cannot load messages as",this,"require is not set");null===t&&(t=5e3),this.messages=null;var n=this;this.require;var i=this._manifest;return t&&(i=i.timeout(t)),this.messagesPromise=i.get("files").then(function(t){return n._loadMessageFiles(t)}).then(function(t){return n._collapseMessages(t)}).fail(function(t){throw console.error("Could not load messages for '"+n.locale+"': "+t),t}).then(function(t){return"function"==typeof e&&e(t),t})}},_loadMessageFiles:{value:function(t){var e=this.require;if(!t)return Promise.reject(Error(e.location+MANIFEST_FILENAME+" does not contain a 'files' property"));var n,i,a,r,s=[];if(!(LOCALES_DIRECTORY in t))return Promise.reject(Error("Package does not contain a '"+LOCALES_DIRECTORY+"' directory"));for(n=t[LOCALES_DIRECTORY].files,i=this._locale;""!==i;)n.hasOwnProperty(i)&&(a=n[i].files,(r=MESSAGES_FILENAME+".js")in a||(r=MESSAGES_FILENAME+".json")in a?s.push(e.async(LOCALES_DIRECTORY+"/"+i+"/"+r)):logger.isDebug&&logger.debug(this,"Warning: '"+LOCALES_DIRECTORY+"/"+i+"/' does not contain '"+MESSAGES_FILENAME+".json' or '"+MESSAGES_FILENAME+".js'")),i=i.substring(0,i.lastIndexOf("-"));if(!s.length)return Promise.reject(Error("Could not find any "+MESSAGES_FILENAME+".json or "+MESSAGES_FILENAME+".js files"));var o=Promise.all(s);if(logger.isDebug){var l=this;o=o.then(function(t){return logger.debug(l,"loaded "+t.length+" message files"),t})}return o}},_collapseMessages:{value:function(t){for(var e={},n=0,i=t.length;i>n;n++){var a=t[n];for(var r in a)r in e||(e[r]=a[r])}return this.messages=e,e}},_compiledMessageCache:{value:Object.create(null)},localizeSync:{value:function(t,e){var n,i,a;if(!t&&!e)throw Error("Key or default message must be truthy, not "+t+" and "+e);if(this._messages&&t in this._messages){if(n=this._messages[t],i=typeof n,"function"===i)return n;if("object"===i){if(!("message"in n))throw Error(n,"does not contain a 'message' property");n=n.message}}else n=e;if(n||(console.warn("No message or default message for key '"+t+"'"),n=t),n in this._compiledMessageCache)return this._compiledMessageCache[n];var r=this.messageFormat.parse(n);return r.program&&r.program.statements&&1===r.program.statements.length&&"string"===r.program.statements[0].type?(a=function(){return n},a.toString=a):a=Function("MessageFormat","return "+this.messageFormat.precompile(r))(MessageFormat),this._compiledMessageCache[n]=a,a}},localize:{value:function(t,e,n,i){var a,r=this;if(n=n===void 0?!0:n,!this.messagesPromise)return a=Promise.resolve(this.localizeSync(t,e)),a.then(i),a;var s=function(){var n=r.localizeSync(t,e);return"function"==typeof i&&i(n),n};return n?this.messagesPromise.then(s,s):this.messagesPromise.then(s)}}}),DefaultLocalizer=Localizer.specialize({init:{value:function(){var t=this.callDelegateMethod("getDefaultLocale");return t||"undefined"==typeof window||(window.localStorage&&(t=window.localStorage.getItem(LOCALE_STORAGE_KEY)),t=t||window.navigator.userLanguage||window.navigator.language),t=t||"en",this.locale=t,this.loadMessages().done(),this}},_delegate:{value:null},delegate:{get:function(){return this._delegate},set:function(t){this._delegate!==t&&(this._delegate=t,this.init())}},locale:{get:function(){return this._locale},set:function(t){try{Object.getPropertyDescriptor(Localizer.prototype,"locale").set.call(this,t)}catch(e){t="en",Object.getPropertyDescriptor(Localizer.prototype,"locale").set.call(this,t)}"undefined"!=typeof window&&window.localStorage&&window.localStorage.setItem(LOCALE_STORAGE_KEY,t)}},reset:{value:function(){return"undefined"!=typeof window&&window.localStorage&&window.localStorage.removeItem(LOCALE_STORAGE_KEY),this.init(),this._locale}}}),defaultLocalizer=exports.defaultLocalizer=(new DefaultLocalizer).init();exports.localize=defaultLocalizer.localize.bind(defaultLocalizer);var Message=exports.Message=Montage.specialize({constructor:{value:function(){this.defineBinding("_data",{"<-":"_dataObject.toMap()"}),this._data.addMapChangeListener(this,"data")}},init:{value:function(t,e,n){return t&&(this.key=t),e&&(this.defaultMessage=e),n&&(this.data=n),this}},_localizer:{value:defaultLocalizer},localizer:{get:function(){return this._localizer},set:function(t){this._localizer!=t&&(this._localizer=t,this._localize())}},_key:{value:null},key:{get:function(){return this._key},set:function(t){this._key!==t&&(this._key=t,this._localize())}},_defaultMessage:{value:null},defaultMessage:{get:function(){return this._defaultMessage},set:function(t){this._defaultMessage!==t&&(this._defaultMessage=t,this._localize())}},_isLocalizeQueued:{value:!1},_localize:{value:function(){if(!this._isLocalizeQueued){this._isLocalizeQueued=!0;var t=this,e=Promise.defer();this._messageFunction=e.promise,this.localized=this._messageFunction.then(function(e){return e(t._data.toObject())}),Promise.nextTick(function(){return t._isLocalizeQueued=!1,t._key||t._defaultMessage?(e.resolve(t._localizer.localize(t._key,t._defaultMessage)),void 0):(console.warn("Both key and default message are falsey for",t,"If this is in a repetition this warning can be ignored"),e.resolve(EMPTY_STRING_FUNCTION),void 0)})}}},_messageFunction:{value:Promise.resolve(EMPTY_STRING_FUNCTION)},_dataObject:{value:null},_data:{value:null},data:{get:function(){return this._data},set:function(t){this._dataObject!==t&&(this._dataObject=t)}},__localizedResolved:{value:""},_localizedDeferred:{value:Promise.defer()},localized:{get:function(){return this._localizedDeferred.promise},set:function(t){if(t!==this._localized){var e=this,n=Promise.defer();this._localizedDeferred.resolve(n.promise),t.then(n.resolve,n.reject),n.promise.then(function(t){return e.__localizedResolved=t}).done(),this._localizedDeferred=n}}},handleDataMapChange:{value:function(){this.localized=this._messageFunction.fcall(this._data.toObject())}},serializeSelf:{value:function(){var t={_bindingDescriptors:this._bindingDescriptors};return t.key=this._key,t.defaultMessage=this._defaultMessage,this._localizer!==defaultLocalizer&&(t.localizer=this._localizer),t}},serializeForLocalizations:{value:function(t){var e,n,i={};n=FrbBindings.getBindings(this),n&&n.key?(i[KEY_KEY]={},this._serializeBinding(this,i[KEY_KEY],n.key,t)):i[KEY_KEY]=this._key,n&&n.defaultMessage?(i[DEFAULT_MESSAGE_KEY]={},this._serializeBinding(this,i[DEFAULT_MESSAGE_KEY],n.defaultMessage,t)):i[DEFAULT_MESSAGE_KEY]=this._defaultMessage;var a=FrbBindings.getBindings(this._data);e=this._data.toObject();for(var r in e)!e.hasOwnProperty(r)||a&&a[".get('"+r+"')"]||(i.data||(i.data={}),i.data[r]=e[r]);for(var s in a){var o=/\.get\('([^']+)'\)/.exec(s)[1];i.data||(i.data={}),i.data[o]={},this._serializeBinding(this._data,i.data[o],a[s],t)}return i}},_serializeBinding:{value:function(t,e,n,i){if(!("serializable"in n)||n.serializable){var a=n.sourceSyntax;if(n.source!==t){var r=i.addObjectReference(n.source),s=new Scope({type:"component",label:r["@"]});s.components=i,a=expand(a,s)}var s=new Scope;s.components=i;var o=stringify(a,s);n.twoWay?e["<->"]=o:e["<-"]=o,n.converter?e.converter=n.converter:(e.convert=n.convert,e.revert=n.revert),n.trace&&(e.trace=!0)}}}}),createMessageBinding=function(t,e,n,i,a,r){var s=new Message;for(var o in a)"string"==typeof a[o]?s.data.set(o,a[o]):Bindings.defineBinding(s.data,".get('"+o+"')",a[o],{components:r});"object"==typeof n?Bindings.defineBinding(s,"key",n,{components:r}):s.key=n,"object"==typeof i?Bindings.defineBinding(s,"defaultMessage",i,{components:r}):s.defaultMessage=i,Bindings.defineBinding(t,e,{"<-":"__localizedResolved",source:s,serializable:!1})};Serializer.defineSerializationUnit("localizations",function(t,e){var n=FrbBindings.getBindings(e);if(n){var i;for(var a in n){var r=n[a];if(Message.prototype.isPrototypeOf(r.source)){i||(i={});var s=r.source;i[a]=s.serializeForLocalizations(t)}}return i}}),Deserializer.defineDeserializationUnit("localizations",function(t,e,n){for(var i in n){var a,r,s=n[i];KEY_KEY in s?(!logger.isDebug||DEFAULT_MESSAGE_KEY in s||logger.debug(this,"Warning: localized property '"+i+"' does not contain a default message property ("+DEFAULT_MESSAGE_KEY+"), in ",e),a=s[KEY_KEY],r=s[DEFAULT_MESSAGE_KEY],createMessageBinding(e,i,a,r,s.data,t)):console.error("localized property '"+i+"' must contain a key property ("+KEY_KEY+"), in ",n[i])}});