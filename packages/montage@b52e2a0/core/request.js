var Promise=require("./promise").Promise;exports=module.exports=function(t){t=exports.normalizeRequest(t);var e=Promise.defer(),n=t.xhr||new XMLHttpRequest;n.open(t.method,t.url,!0),n.onload=function(){var t={status:n.status,headers:exports.parseResponseHeaders(n.getAllResponseHeaders()),body:n.response,xhr:n};e.resolve(t)},n.onerror=function(){e.reject(Error("Could not load"))};var i=t.headers;for(var r in i){var a=i[r];if(Array.isArray(a))for(var o=0;a.length>o;o++)n.setRequestHeader(r,a[o]);else n.setRequestHeader(r,a)}var s=t.options;for(var l in s)n[l]=s[l];return t.overrideMimeType&&n.overrideMimeType(t.overrideMimeType),n.send(t.body),e.promise},exports.request=exports,exports.makeOk=function(t){return function(e){e=exports.normalizeRequest(e);var n=e.url;return Promise.when(t(e),function(t){if(t.status>=200&&300>t.status)return t;var e=Error("Could not load "+JSON.stringify(n)+": "+t.status+" "+t.xhr.statusText);throw e.response=t,e})}},exports.ok=exports.makeOk(exports.request),exports.makeJson=function(t){return function(e){e=exports.normalizeRequest(e);var n=e.url;return e.headers.accept=e.headers.accept||"application/json",e.headers["content-type"]=e.headers["content-type"]||"application/json","object"==typeof e.body&&(e.body=JSON.stringify(e.body)),e.overrideMimeType=e.overrideMimeType||"application/json",e.options.responseType=e.options.responseType||"json",Promise.when(t(e),function(t){if(null===t.body||"string"==typeof t.body)try{t.body=JSON.parse(t.body)}catch(e){throw Error("Could not parse JSON from "+JSON.stringify(n)+": "+e.message)}return t})}},exports.json=exports.makeJson(exports.request),exports.normalizeRequest=function(t){return"string"==typeof t&&(t={url:t}),t.method=t.method||"GET",t.headers=t.headers||{},t.options=t.options||{},t},exports.parseResponseHeaders=function(t){var e={};return t?(t.replace(/^([^:]+):(.*)$/gm,function(t,n,i){n=n.trim().toLowerCase(),i=i.trim(),n in e?("string"==typeof e[n]&&(e[n]=[e[n]]),e[n].push(i)):e[n]=i}),e):e};