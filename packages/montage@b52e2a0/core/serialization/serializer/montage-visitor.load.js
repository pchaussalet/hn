montageDefine("b52e2a0","core/serialization/serializer/montage-visitor",{dependencies:["../../core","./montage-serializer","./properties-serializer","./self-serializer","./unit-serializer","../alias","mousse/serialization/visitor"],factory:function(t,e){var n=t("../../core").Montage,i=t("./montage-serializer"),r=t("./properties-serializer").PropertiesSerializer,a=t("./self-serializer").SelfSerializer,o=t("./unit-serializer").UnitSerializer,s=t("../alias").Alias,l=t("mousse/serialization/visitor").Visitor,c=n.specialize.call(l,{_MONTAGE_ID_ATTRIBUTE:{value:"data-montage-id"},_require:{value:null},_units:{value:null},_elements:{value:null},constructor:{value:function c(){}},initWithBuilderAndLabelerAndRequireAndUnits:{value:function(t,e,n,i){return l.call(this,t,e),this._require=n,this._units=i,this._elements=[],this}},getTypeOf:{value:function(t){return t.isModuleReference?"Module":t instanceof s?"Alias":"getInfoForObject"in t||"getInfoForObject"in t.constructor?"MontageObject":t.thisIsAReferenceCreatedByMontageSerializer?"MontageReference":"undefined"!=typeof Element&&Element.isElement(t)?"Element":void 0}},visitMontageReference:{value:function(t,e,n){this.builder.top.setProperty(n,e.reference)}},visitElement:{value:function(t,e,n){var i,r;if(r=e.getAttribute(this._MONTAGE_ID_ATTRIBUTE),!r)throw Error("Not possible to serialize a DOM element with no "+this._MONTAGE_ID_ATTRIBUTE+" assigned: "+e.outerHTML);i=this.builder.createElementReference(r),this.storeValue(i,e,n),this._elements.push(e)}},visitModule:{value:function(t,e,n){var i,r;try{r=e.resolve(this._require)}catch(a){throw Error("Not possible to serialize module reference "+e.id+" from package "+e.require.location+" inside package "+this._require.location)}i=this.builder.createModuleReference(r),this.storeValue(i,e,n)}},visitAlias:{value:function(t,e){var n=this.labeler.getTemplatePropertyLabel(e),i=this.builder.createCustomObject();i.setProperty("alias",e.value),this.builder.top.setProperty(n,i)}},visitMontageObject:{value:function(t,e,n){this.isObjectSerialized(e)?this.serializeReferenceToMontageObject(t,e,n):this.handleMontageObject(t,e,n)}},handleMontageObject:{value:function(t,e,n){var i,r=this.builder.createCustomObject();this.setObjectSerialization(e,r),i=this.serializeMontageObject(t,e,r),i?this.serializeSubstituteObject(t,e,n,r,i):(r.setLabel(this.labeler.getObjectLabel(e)),this.builder.top.setProperty(n,r))}},serializeReferenceToMontageObject:{value:function(t,e,n){var i=this.labeler.getObjectLabel(e),r=this.builder.createObjectReference(i);this.builder.top.setProperty(n,r)}},serializeSubstituteObject:{value:function(t,e,n,i,r){var a,o,s,l;a=this.labeler.getObjectLabel(e),this.labeler.isUserDefinedLabel(a)?(o=this.labeler.getObjectLabel(r),this.labeler.setObjectLabel(r,a),this.builder.relabelReferences(o,a),l=this.getObjectSerialization(r),l&&(l.setLabel(a),this.labeler.isUserDefinedLabel(o)&&this.builder.createObjectReference(a).setLabel(o)),t.visit(r,n)):(t.visit(r,n),s=this.labeler.getObjectLabel(r),this.labeler.setObjectLabel(e,s),this.builder.relabelReferences(a,s))}},serializeMontageObject:{value:function(t,e,n){var i,r,o=this.builder.createObjectLiteral();return this.setObjectType(e,n),n.setProperty("properties",o),this.builder.push(n),"function"==typeof e.serializeSelf?(i=(new a).initWithMalkerAndVisitorAndObject(t,this,e,n),r=e.serializeSelf(i)):(this.setObjectProperties(t,e),this.setObjectCustomUnits(t,e)),this.builder.pop(),0===o.getPropertyNames().length&&n.clearProperty("properties"),r}},setObjectType:{value:function(t,e){var i=n.getInfoForObject(t).isInstance,r=this.getObjectLocationId(t),a=this.builder.createString(r);i?e.setProperty("prototype",a):e.setProperty("object",a)}},getObjectModuleId:{value:function(t){var e=n.getInfoForObject(t);return this._require.identify(e.moduleId,e.require)}},getObjectLocationId:{value:function(t){var e,r=this.getObjectModuleId(t),a=n.getInfoForObject(t),o=a.objectName;return e=i.MontageSerializer.getDefaultObjectNameForModuleId(r),e===o?r:r+"["+o+"]"}},setObjectProperties:{value:function(t,e){var n,i;i=this.builder.top.getProperty("properties"),this.builder.push(i),"function"==typeof e.serializeProperties?(n=(new r).initWithMalkerAndVisitorAndObject(t,this,e),e.serializeProperties(n)):this.setSerializableObjectProperties(t,e),this.builder.pop()}},setSerializableObjectProperties:{value:function(t,e){for(var i,r,a=n.getSerializablePropertyNames(e),o=a.length,s=0;o>s;s++)r=a[s],i=n.getPropertyAttribute(e,r,"serializable"),this.setProperty(t,r,e[r],i)}},hackIsReferenceAllowedForValue:{value:function(t){return"object"==typeof t&&null!=t&&!("undefined"!=typeof Element&&Element.isElement(t))}},setProperty:{value:function(t,e,n,i){var r;if("reference"===i&&this.hackIsReferenceAllowedForValue(n)){r=this.labeler.getObjectLabel(n);var a=this.builder.createObjectReference(r);this.builder.top.setProperty(e,a)}else t.visit(n,e)}},setObjectCustomUnits:{value:function(t,e){for(var n in this._units)this.setObjectCustomUnit(t,e,n)}},setObjectCustomUnit:{value:function(t,e,n){var i,r,a=this._units[n];a&&(r=(new o).initWithMalkerAndVisitorAndObject(t,this,e),i=a(r,e),null!=i&&t.visit(i,n))}},getExternalObjects:{value:function(){for(var t,e={},n=this.builder.getExternalReferences(),i=0;t=n[i];i++)e[t]=this.labeler.getObjectByLabel(t);return e}},getExternalElements:{value:function(){return this._elements}}});e.MontageVisitor=c}});