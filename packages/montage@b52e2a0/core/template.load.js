montageDefine("b52e2a0","core/template",{dependencies:["./core","./serialization","./document-part","./document-resources","./serialization/serialization","./serialization/serializer/montage-labeler","./promise","./mini-url","./logger","./event/event-manager","./application"],factory:function(t,e){function n(t,e,n){var i,r,a=new d,s=t.documentElement.outerHTML,l=new o,c=t.documentElement;return i=a.createHtmlDocumentWithHtml(s,t.location.href),a.initWithDocument(i,e).then(function(){return a.setBaseUrl(t.location.href),r=a._createTemplateObjects(n),l.initWithTemplateAndFragment(a),a._instantiateObjects(r,c).then(function(t){return l.objects=t,a._invokeDelegates(l),l})})}var i,r=t("./core").Montage,a=t("./serialization").Deserializer,o=t("./document-part").DocumentPart,s=t("./document-resources").DocumentResources,l=t("./serialization/serialization").Serialization,c=t("./serialization/serializer/montage-labeler").MontageLabeler,u=t("./promise").Promise,h=t("./mini-url");t("./logger").logger("template"),t("./event/event-manager").defaultEventManager;var d=r.specialize({_SERIALIZATON_SCRIPT_TYPE:{value:"text/montage-serialization"},_ELEMENT_ID_ATTRIBUTE:{value:"data-montage-id"},PARAM_ATTRIBUTE:{value:"data-param"},_require:{value:null},_resources:{value:null},_baseUrl:{value:null},_instances:{value:null},_metadata:{value:null},_objectsString:{value:null},objectsString:{get:function(){return this._objectsString},set:function(t){this._objectsString=t,this._serialization&&this._serialization.initWithString(t),this.__deserializer=null}},__deserializer:{value:null},_deserializer:{get:function(){var t,e,n=this.__deserializer;if(!n){if(t=this._metadata){e=Object.create(null);for(var i in t)e[i]=t[i].require}n=(new a).init(this.objectsString,this._require,e),this.__deserializer=n}return n}},getDeserializer:{value:function(){return this._deserializer}},_serialization:{value:null},getSerialization:{value:function(){var t=this._serialization;return t||(t=this._serialization=new l,t.initWithString(this.objectsString)),t}},_isDirty:{value:!1},isDirty:{get:function(){return this._isDirty},set:function(t){this._isDirty!==t&&(this._isDirty=t,this.clearTemplateFromElementContentsCache())}},refresher:{value:null},_document:{value:null},document:{get:function(){return this._isDirty&&this.refresh(),this._document},set:function(t){this._document=t}},constructor:{value:function d(){this.super()}},initWithRequire:{value:function(t){return this._require=t,this.document=this.createHtmlDocumentWithHtml(""),this.objectsString="",this}},initWithDocument:{value:function(t,e){var n=this;return this._require=e,this.setDocument(t),this.getObjectsString(t).then(function(t){return n.objectsString=t,n})}},initWithHtml:{value:function(t,e){var n=this;return this._require=e,this.document=this.createHtmlDocumentWithHtml(t),this.getObjectsString(this.document).then(function(t){return n.objectsString=t,n})}},initWithObjectsAndDocumentFragment:{value:function(t,e,n){return this._require=n,this.document=this.createHtmlDocumentWithHtml(""),this.document.body.appendChild(this.document.importNode(e,!0)),this.setObjects(t),this}},initWithModuleId:{value:function(t,e){var n=this;return this._require=e,this.createHtmlDocumentWithModuleId(t,e).then(function(i){var r=e(t).directory;return n.document=i,n.setBaseUrl(r),n.getObjectsString(i).then(function(t){return n.objectsString=t,n})})}},clone:{value:function(){var t=new d;return t._require=this._require,t._baseUrl=this._baseUrl,t.setDocument(this.document),t.objectsString=this.objectsString,t._instances=Object.clone(this._instances,1),t}},instantiate:{value:function(t){return this.instantiateWithInstances(null,t)}},instantiateWithInstances:{value:function(t,e){var n,i,r,a=this,s=new o;return t=t||this._instances,n=this._createMarkupDocumentFragment(e),r=this._getParameters(n),s.initWithTemplateAndFragment(this,n),s.startActingAsTopComponent(),s.parameters=r,i=this._createTemplateObjects(t),this._instantiateObjects(i,n).then(function(n){var i;return s.objects=n,a._invokeDelegates(s,t),s.stopActingAsTopComponent(),i=a.getResources(),!i.resourcesLoaded()&&i.hasResources()&&i.loadResources(e).done(),s})}},_objectsInstantiationOptimized:{value:!1},_optimizeObjectsInstantiationPromise:{value:null},_optimizeObjectsInstantiation:{value:function(){var t,e=this;return this._objectsInstantiationOptimized?void 0:(this._optimizeObjectsInstantiationPromise||(t=this._deserializer.preloadModules(),t?this._optimizeObjectsInstantiationPromise=t.then(function(){e._objectsInstantiationOptimized=!0}):this._objectsInstantiationOptimized=!0),this._optimizeObjectsInstantiationPromise)}},setBaseUrl:{value:function(t){this._baseUrl=t}},getBaseUrl:{value:function(){return this._baseUrl}},getResources:{value:function(){var t=this._resources;return t||(t=this._resources=new p,t.initWithTemplate(this)),t}},_createTemplateObjects:{value:function(e){var n=Object.create(e||null);return i===void 0&&(i=t("./application").application),n.application=i,n.template=this,n}},_instantiateObjects:{value:function(t,e){var n,i=this._deserializer;return n=this._optimizeObjectsInstantiation(),n?n.then(function(){return i.deserialize(t,e)}):i.deserialize(t,e)}},_createMarkupDocumentFragment:{value:function(t){for(var e=t.createDocumentFragment(),n=this.document.body.childNodes,i=0,r=n.length;r>i;i++)e.appendChild(t.importNode(n[i],!0));return e}},getParameterName:{value:function(t){return t.getAttribute(this.PARAM_ATTRIBUTE)}},getParameters:{value:function(){return this._getParameters(this.document.body)}},_getParameters:{value:function(t){for(var e,n=t.querySelectorAll("*["+this.PARAM_ATTRIBUTE+"]"),i=n.length,r={},a=0;i>a;a++){e=n[a];var o=this.getParameterName(e);if(o in r)throw Error('The parameter "'+o+'" is'+" declared more than once in "+this.getBaseUrl()+".");r[o]=e}if("*"in r&&i>1)throw Error('The star "*" template parameter was declared when other parameters were also present in '+this.getBaseUrl()+": "+Object.keys(r)+".");return r}},hasParameters:{value:function(){return!!this.document.querySelector("*["+this.PARAM_ATTRIBUTE+"]")}},_invokeDelegates:{value:function(t,e){var n,i,r,a=t.objects,o=a.owner||e&&e.owner;for(var s in a)e&&s in e||(n=a[s],i=this._getObjectOwner(s,o),r=this._getObjectLabel(s),n&&("function"==typeof n._deserializedFromTemplate&&n._deserializedFromTemplate(i,r,t),"function"==typeof n.deserializedFromTemplate&&n.deserializedFromTemplate(i,r,t)));if(o){var l=this.getSerialization();l.isExternalObject("owner")||("function"==typeof o._templateDidLoad&&o._templateDidLoad(t),"function"==typeof o.templateDidLoad&&o.templateDidLoad(t))}}},setInstances:{value:function(t){this._instances=t}},getInstances:{value:function(){return this._instances}},setObjects:{value:function(t){this.objectsString=JSON.stringify(t,null,4)}},setObjectMetadata:{value:function(t,e,n,i){var r=this._metadata;r||(this._metadata=r=Object.create(null)),r[t]={require:e,label:n,owner:i},this.__deserializer=null}},getObjectMetadata:{value:function(t){var e=this._metadata;return e&&t in e?e[t]:{require:this._require,label:t}}},_getObjectOwner:{value:function(t,e){var n,i=this._metadata;return n=i&&t in i?i[t].owner:e}},_getObjectLabel:{value:function(t){var e,n=this._metadata;return e=n&&t in n?n[t].label:t}},setDocument:{value:function(t){var e=t.documentElement.innerHTML;this.document=this.createHtmlDocumentWithHtml(e,t.baseURI),this.clearTemplateFromElementContentsCache()}},getObjectsString:{value:function(t){var e;return e=this.getInlineObjectsString(t),null===e?this.getExternalObjectsString(t):u.resolve(e)}},getInlineObjectsString:{value:function(t){var e="script[type='"+this._SERIALIZATON_SCRIPT_TYPE+"']",n=t.querySelector(e);return n?n.textContent:null}},getExternalObjectsString:{value:function(t){var e,n,i,r=t.querySelector('link[rel="serialization"]');return r?(e=new XMLHttpRequest,n=r.getAttribute("href"),i=u.defer(),e.open("GET",n),e.addEventListener("load",function(){200==e.status?i.resolve(e.responseText):i.reject(Error("Unable to retrive '"+n+"', code status: "+e.status))},!1),e.addEventListener("error",function(t){i.reject(Error("Unable to retrive '"+n+"' with error: "+t.error+"."))},!1),e.send(),i.promise):u.resolve(null)}},createHtmlDocumentWithHtml:{value:function(t,e){var n=document.implementation.createHTMLDocument("");return n.documentElement.innerHTML=t,this.normalizeRelativeUrls(n,e),n}},createHtmlDocumentWithModuleId:{value:function(t,e){var n=this;return"function"!=typeof e?u.reject(Error("Missing 'require' function to load module '"+t+"'.")):e.async(t).then(function(t){return n.createHtmlDocumentWithHtml(t.content,t.directory)})}},_removeObjects:{value:function(t){var e="script[type='"+this._SERIALIZATON_SCRIPT_TYPE+"'], link[rel='serialization']";Array.prototype.forEach.call(t.querySelectorAll(e),function(t){t.parentNode.removeChild(t)})}},_addObjects:{value:function(t,e){if(e){var n=t.createElement("script");n.setAttribute("type",this._SERIALIZATON_SCRIPT_TYPE),n.textContent=JSON.stringify(JSON.parse(e),null,4),t.head.appendChild(n)}}},_templateFromElementContentsCache:{value:null},clearTemplateFromElementContentsCache:{value:function(){this._templateFromElementContentsCache=null}},createTemplateFromElementContents:{value:function(t){var e,n,i,r=this._templateFromElementContentsCache;return r||(r=Object.create(null),this._templateFromElementContentsCache=r),t in r?Object.create(r[t]):(e=this.getElementById(t),i=this.document.createRange(),i.selectNodeContents(e),n=this.createTemplateFromRange(i),r[t]=n,Object.create(n))}},createTemplateFromElement:{value:function(t){var e,n;return e=this.getElementById(t),n=this.document.createRange(),n.selectNode(e),this.createTemplateFromRange(n)}},createTemplateFromRange:{value:function(t){var e,n,i,r,a,o=new l;return e=t.cloneContents(),n=this._getChildrenElementIds(e),o.initWithString(this.objectsString),i=o.getSerializationLabelsWithElements(n),a=o.extractSerialization(i,["owner"]),r=new d,r.initWithObjectsAndDocumentFragment(null,e,this._require),r.objectsString=a.getSerializationString(),r._resources=this.getResources(),r}},_createSerializationWithElementIds:{value:function(t){var e,n,i=new l;return i.initWithString(this.objectsString),e=i.getSerializationLabelsWithElements(t),n=i.extractSerialization(e,["owner"])}},expandParameters:{value:function(t){var e,n,i,r,a,o,s,l=[],c={},u=this.getSerialization(),h={};e=this.getParameters();for(var d in e)if(r=e[d],a=t.getTemplateArgumentElement(d),l.push.apply(l,this._getElementIds(a)),n=this.replaceNode(a,r))for(var p in n)c[p]=n[p];return h.elementIds=l,h.elementIdsCollisions=c,o=t.getTemplateArgumentSerialization(l),o.renameElementReferences(c),s=function(e){return e.indexOf(":")>0?t.resolveTemplateArgumentTemplateProperty(e):void 0},i=u.mergeSerialization(o,{willMergeObjectWithLabel:s}),this.objectsString=u.getSerializationString(),h.labels=o.getSerializationLabels(),h.labelsCollisions=i,h}},_resolveElementIdCollisions:{value:function(t,e){var n,i,r,a,o;e=e||new c,r=this.getElementIds();for(var s,l=0;s=r[l];l++)e.addLabel(s);i=this._getElements(t);for(var s in i)this.getElementById(s)&&(a=i[s],o=e.generateLabel(e.getLabelBaseName(s)),this.setElementId(a,o),n||(n=Object.create(null)),n[s]=o);return n}},replaceNode:{value:function(t,e,n){var i;return i=this._resolveElementIdCollisions(t,n),this.normalizeRelativeUrls(t,this.getBaseUrl()),e.parentNode.replaceChild(t,e),i}},insertNodeBefore:{value:function(t,e,n){var i;return i=this._resolveElementIdCollisions(t,n),this.normalizeRelativeUrls(t,this.getBaseUrl()),e.parentNode.insertBefore(t,e),i}},appendNode:{value:function(t,e,n){var i;return i=this._resolveElementIdCollisions(t,n),this.normalizeRelativeUrls(t,this.getBaseUrl()),e.appendChild(t),i}},getElementId:{value:function(t){return t.getAttribute?t.getAttribute(this._ELEMENT_ID_ATTRIBUTE):void 0}},setElementId:{value:function(t,e){t.setAttribute(this._ELEMENT_ID_ATTRIBUTE,e)}},getElementIds:{value:function(){return this._getElementIds(this.document.body)}},_getElements:{value:function(t){var e,n,i="*["+this._ELEMENT_ID_ATTRIBUTE+"]",r={};e=t.querySelectorAll(i);for(var a,o=0;a=e[o];o++)n=this.getElementId(a),r[n]=a;return n=this.getElementId(t),n&&(r[n]=t),r}},_getChildrenElementIds:{value:function(t){var e,n="*["+this._ELEMENT_ID_ATTRIBUTE+"]",i=[];e=t.querySelectorAll(n);for(var r,a=0;r=e[a];a++)i.push(this.getElementId(r));return i}},_getElementIds:{value:function(t){var e,n=this._getChildrenElementIds(t);return e=this.getElementId(t),e&&n.push(e),n}},getElementById:{value:function(t){var e="*["+this._ELEMENT_ID_ATTRIBUTE+"='"+t+"']";return this.document.querySelector(e)}},html:{get:function(){var t=this.document;return this._removeObjects(t),this._addObjects(t,this.objectsString),this._getDoctypeString(t.doctype)+"\n"+t.documentElement.outerHTML}},_getDoctypeString:{value:function(t){return"<!DOCTYPE "+t.name+(t.publicId?' PUBLIC "'+t.publicId+'"':"")+(!t.publicId&&t.systemId?" SYSTEM":"")+(t.systemId?' "'+t.systemId+'"':"")+">"}},normalizeRelativeUrls:{value:function(t,e){if("string"==typeof e&&""!==e&&"about:blank"!==e)for(var n="http://www.w3.org/1999/xlink",i=/^[\w\-]+:|^\//,r=-1!==d._NORMALIZED_TAG_NAMES.indexOf(t.tagName)?[t]:t.querySelectorAll(d._NORMALIZED_TAG_NAMES_SELECTOR),a=0,o=r.length;o>a;a++){var s,l=r[a];"image"===l.tagName?(s=l.getAttributeNS(n,"href"),i.test(s)||l.setAttributeNS(n,"href",h.resolve(e,s))):l.hasAttribute("src")?(s=l.getAttribute("src"),""===s||i.test(s)||l.setAttribute("src",h.resolve(e,s))):l.hasAttribute("href")&&(s=l.getAttribute("href"),""===s||i.test(s)||l.setAttribute("href",h.resolve(e,s)))}}},replaceContentsWithTemplate:{value:function(t){this._require=t._require,this._baseUrl=t._baseUrl,this._document=t._document,this.objectsString=t.objectsString,this._instances=t._instances,this._templateFromElementContentsCache=t._templateFromElementContentsCache,this._metadata=t._metadata}},refresh:{value:function(){this.isDirty&&(this.refresher&&"function"==typeof this.refresher.refreshTemplate?(this.refresher.refreshTemplate(this),this.isDirty=!1):console.warn("Not able to refresh without a refresher.refreshTemplate."))}}},{_templateCache:{value:{moduleId:Object.create(null)}},_getTemplateCacheKey:{value:function(t,e){return t=e.resolve(t),e.location+"#"+t}},getTemplateWithModuleId:{value:function(t,e){var n,i;return n=this._getTemplateCacheKey(t,e),i=this._templateCache.moduleId[n],i||(i=(new d).initWithModuleId(t,e),this._templateCache.moduleId[n]=i),i}},_NORMALIZED_TAG_NAMES:{value:["IMG","image","IFRAME","link","script"]},__NORMALIZED_TAG_NAMES_SELECTOR:{value:null},_NORMALIZED_TAG_NAMES_SELECTOR:{get:function(){return this.__NORMALIZED_TAG_NAMES_SELECTOR||(this.__NORMALIZED_TAG_NAMES_SELECTOR=this._NORMALIZED_TAG_NAMES.join(",")),this.__NORMALIZED_TAG_NAMES_SELECTOR}}}),p=r.specialize({_resources:{value:null},_resourcesLoaded:{value:!1},template:{value:null},rootUrl:{value:""},constructor:{value:function p(){this._resources=Object.create(null)}},initWithTemplate:{value:function(t){this.template=t}},hasResources:{value:function(){return this.getStyles().length>0||this.getScripts().length>0}},resourcesLoaded:{value:function(){return this._resourcesLoaded}},loadResources:{value:function(t){return this._resourcesLoaded=!0,u.all([this.loadScripts(t),this.loadStyles(t)])}},getScripts:{value:function(){var t,e,n,i=this._resources.scripts;if(!i){e=this.template,i=this._resources.scripts=[],n=e.document.querySelectorAll("script");for(var r=0,a=n.length;a>r;r++)t=n[r],t.type!==this.template._SERIALIZATON_SCRIPT_TYPE&&i.push(t)}return i}},loadScripts:{value:function(t){var e,n=[];e=this.getScripts();for(var i=0,r=e.length;r>i;i++)n.push(this.loadScript(e[i],t));return u.all(n)}},loadScript:{value:function(t,e){var n,i;return n=s.getInstanceForDocument(e),i=this._cloneScriptElement(t,e),n.addScript(i)}},_cloneScriptElement:{value:function(t,e){for(var n,i=e.createElement("script"),r=t.attributes,a=0,o=r.length;o>a;a++)n=r[a],i.setAttribute(n.name,n.value);return i.textContent=t.textContent,i}},getStyles:{value:function(){var t,e,n,i=this._resources.styles;return i||(n='link[rel="stylesheet"], style',t=this.template,e=t.document.querySelectorAll(n),i=Array.prototype.slice.call(e,0),this._resources.styles=i),i}},loadStyles:{value:function(t){var e,n=[];e=this.getStyles();for(var i=0,r=e.length;r>i;i++)n.push(this.loadStyle(e[i],t));return u.all(n)}},loadStyle:{value:function(t,e){var n,i;return n=t.getAttribute("href"),n?(i=s.getInstanceForDocument(e),i.preloadResource(n)):u.resolve()}},createStylesForDocument:{value:function(t){for(var e,n,i=this.getStyles(),r=[],a=0;n=i[a];a++)e=t.importNode(n,!0),r.push(e);return r}}}),f=r.specialize({getTemplateArgumentElement:{value:function(){}},getTemplateArgumentSerialization:{value:function(){}},resolveTemplateArgumentTemplateProperty:{value:function(){}}});e.Template=d,e.TemplateArgumentProvider=f,e.TemplateResources=p,e.instantiateDocument=n}});