function parseHtml(t){var e,n,i=new htmlparser.DomHandler(function(t,i){n=t,e=i}),r=new htmlparser.Parser(i);if(r.write(t),r.done(),n)throw n;if(!e)throw Error("HTML parsing did not complete");return{type:"document",children:e}}function visit(t,e){var n,i=function(){n=!0};if(e(t,i),!n)for(var r=t.children,a=r?r.length:0,o=0;a>o;o++)visit(r[o],e)}function getAttribute(t,e){return t.attribs?t.attribs[e]:null}function getText(t){return DomUtils.getText(t)}function parsePrototypeForModule(t){return t.replace(/\[[^\]]+\]$/,"")}var FS=require("q-io/fs"),MontageBoot=require("./montage"),Require=require("mr/require");require("mr/node");var Promise=require("q"),URL=require("url"),htmlparser=require("htmlparser2"),DomUtils=htmlparser.DomUtils;Require.overlays=["node","server","montage"],exports.bootstrap=function(){var t=process.argv.slice(0,3),e=process.argv.slice(2),n=e.shift();return FS.canonical(n).then(function(n){return findPackage(n).fail(function(i){if("Can't find package"!==i.message)throw Error(i);loadFreeModule(n,t,e)}).then(function(i){return loadPackagedModule(i,n,t,e)})})};var findPackage=function(t){var e=FS.directory(t);if(e===t)throw Error("Can't find package");return FS.join(e,"package.json"),FS.stat(t).then(function(t){return t.isFile()?e:findPackage(e)})},loadFreeModule=function(){throw Error("Can't load module that is not in a package")},loadPackagedModule=function(t,e){return MontageBoot.loadPackage(t).then(function(n){var i=e.slice(t.length+1);return n.async(i)}).done()};MontageBoot.loadPackage=function(t,e){return"/"!==t.slice(t.length-1,t.length)&&(t+="/"),e=e||{},e.location=URL.resolve(Require.getLocation(),t),e.moduleTypes=["html","meta"],e.makeLoader=function(t){return MontageBoot.ReelLoader(t,Require.makeLoader(t))},e.makeCompiler=function(t){return MontageBoot.TemplateCompiler(t,MontageBoot.SerializationCompiler(t,Require.makeCompiler(t)))},Require.loadPackage(e.location,e)},MontageBoot.TemplateLoader=function(t,e){return function(t,n){var i=t.match(/(.*\/)?(?=[^\/]+\.html$)/),r=t.match(/(?=[^\/]+\.json$)/),a=t.match(/(.*\/)?([^\/]+)\.reel\/\2$/);return i?e(t,n).then(function(){return n.dependencies=parseHtmlDependencies(n.text,n.location),n}):r?e(t,n).then(function(){return n.dependencies=collectSerializationDependencies(n.text,[]),n}):a?e(t,n).then(function(){var e=URL.resolve(n.location,a[2]+".html");return FS.stat(URL.parse(e).pathname).then(function(e){e.isFile()&&(n.extraDependencies=[t+".html"])},function(){})}):e(t,n)}},Require.makeLoader=function(t){return function(e){return MontageBoot.TemplateLoader(e,t(e))}}(Require.makeLoader);var parseHtmlDependencies=function(t){var e=[],n=parseHtml(t);return collectHtmlDependencies(n,e),e},collectHtmlDependencies=function(t,e){visit(t,function(t){DomUtils.isTag(t)&&("script"===t.name?"text/montage-serialization"===getAttribute(t,"type")&&collectSerializationDependencies(getText(t),e):"link"===t.name&&"text/montage-serialization"===getAttribute(t,"type")&&e.push(getAttribute(t,"href")))})},collectSerializationDependencies=function(t,e){var n=JSON.parse(t);return Object.keys(n).forEach(function(t){var i=n[t];i.lazy||("string"==typeof i.prototype&&e.push(parsePrototypeForModule(i.prototype)),"string"==typeof i.object&&e.push(parsePrototypeForModule(i.object)))}),e};