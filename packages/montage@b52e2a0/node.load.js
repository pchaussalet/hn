montageDefine("b52e2a0","node",{dependencies:["q-io/fs","./montage","mr/require","mr/node","q","url","htmlparser2"],factory:function(t,e){function n(t){var e,n,i=new h.DomHandler(function(t,i){n=t,e=i}),r=new h.Parser(i);if(r.write(t),r.done(),n)throw n;if(!e)throw Error("HTML parsing did not complete");return{type:"document",children:e}}function i(t,e){var n,r=function(){n=!0};if(e(t,r),!n)for(var a=t.children,o=a?a.length:0,s=0;o>s;s++)i(a[s],e)}function r(t,e){return t.attribs?t.attribs[e]:null}function a(t){return d.getText(t)}function o(t){return t.replace(/\[[^\]]+\]$/,"")}var s=t("q-io/fs"),l=t("./montage"),c=t("mr/require");t("mr/node"),t("q");var u=t("url"),h=t("htmlparser2"),d=h.DomUtils;c.overlays=["node","server","montage"],e.bootstrap=function(){var t=process.argv.slice(0,3),e=process.argv.slice(2),n=e.shift();return s.canonical(n).then(function(n){return p(n).fail(function(i){if("Can't find package"!==i.message)throw Error(i);f(n,t,e)}).then(function(i){return g(i,n,t,e)})})};var p=function(t){var e=s.directory(t);if(e===t)throw Error("Can't find package");return s.join(e,"package.json"),s.stat(t).then(function(t){return t.isFile()?e:p(e)})},f=function(){throw Error("Can't load module that is not in a package")},g=function(t,e){return l.loadPackage(t).then(function(n){var i=e.slice(t.length+1);return n.async(i)}).done()};l.loadPackage=function(t,e){return"/"!==t.slice(t.length-1,t.length)&&(t+="/"),e=e||{},e.location=u.resolve(c.getLocation(),t),e.moduleTypes=["html","meta"],e.makeLoader=function(t){return l.ReelLoader(t,c.makeLoader(t))},e.makeCompiler=function(t){return l.TemplateCompiler(t,l.SerializationCompiler(t,c.makeCompiler(t)))},c.loadPackage(e.location,e)},l.TemplateLoader=function(t,e){return function(t,n){var i=t.match(/(.*\/)?(?=[^\/]+\.html$)/),r=t.match(/(?=[^\/]+\.json$)/),a=t.match(/(.*\/)?([^\/]+)\.reel\/\2$/);return i?e(t,n).then(function(){return n.dependencies=v(n.text,n.location),n}):r?e(t,n).then(function(){return n.dependencies=b(n.text,[]),n}):a?e(t,n).then(function(){var e=u.resolve(n.location,a[2]+".html");return s.stat(u.parse(e).pathname).then(function(e){e.isFile()&&(n.extraDependencies=[t+".html"])},function(){})}):e(t,n)}},c.makeLoader=function(t){return function(e){return l.TemplateLoader(e,t(e))}}(c.makeLoader);var v=function(t){var e=[],i=n(t);return m(i,e),e},m=function(t,e){i(t,function(t){d.isTag(t)&&("script"===t.name?"text/montage-serialization"===r(t,"type")&&b(a(t),e):"link"===t.name&&"text/montage-serialization"===r(t,"type")&&e.push(r(t,"href")))})},b=function(t,e){var n=JSON.parse(t);return Object.keys(n).forEach(function(t){var i=n[t];i.lazy||("string"==typeof i.prototype&&e.push(o(i.prototype)),"string"==typeof i.object&&e.push(o(i.object)))}),e}}});