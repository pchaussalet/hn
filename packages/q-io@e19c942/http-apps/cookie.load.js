montageDefine("e19c942","http-apps/cookie",{dependencies:["q","../http-cookie"],factory:function(e,t){function n(e){var t=u.exec(e);return t?[t[1],t[2]]:[e,""]}function i(e){var t=n(e),i=t[0],r=t[1];if(c.test(i))return[i+r];if("localhost"===i)return[i+r];for(var t=i.split("."),a=[];t.length>1;)a.push("."+t.join(".")+r),t.shift();return a}function r(e,t){var i=n(e),r=i[0],a=i[1],o=n(t),s=o[0],l=o[1];return a!==l?!1:c.test(r)||c.test(s)?r===s:/^\./.test(r)?s.lastIndexOf(r)===s.length-r.length||r.slice(1)===s:r===s}function a(e,t){return/^\/$/.test(e)?0===t.indexOf(e):t===e||0===t.indexOf(e+"/")}function o(e){return[].concat.apply([],e)}var s=e("q"),l=e("../http-cookie");s.longStackSupport=!0,t.CookieJar=function(e){var t={};return function(u){if(!u.headers.host)throw Error("Requests must have a host header");var h=i(u.headers.host),d=new Date,p=o(h.map(function(e){for(var e in t){var n=t[e];for(var i in n){var s=n[i];for(var l in s){var c=s[l];c.expires&&c.expires>d&&delete c[l]}}}return o(Object.keys(t).map(function(e){if(!r(e,u.headers.host))return[];var n=t[e];return o(Object.keys(n).map(function(e){if(!a(e,u.path))return[];var t=n[e];return Object.keys(t).map(function(e){return t[e]}).filter(function(e){return e.secure?u.ssl:!0})}))}))}));return p.length&&(u.headers.cookie=p.map(function(e){return l.stringify(e.key,e.value,e)}).join("; ")),s.when(e.apply(this,arguments),function(e){if(e.headers=e.headers||{},e.headers["set-cookie"]){var i=u.headers.host,a=n(i),o=a[0],s=c.test(o)?i:"."+i;Array.isArray(e.headers["set-cookie"])||(e.headers["set-cookie"]=[e.headers["set-cookie"]]),e.headers["set-cookie"].forEach(function(n){var i=e.headers.date?new Date(e.headers.date):new Date;n=l.parse(n,i),n.host&&!r(s,n.host)&&delete n.host;var a=s||n.host,o=n.path||"/",c=t[a]=t[a]||{},u=c[o]=c[o]||{};u[n.key]=n}),delete e.headers["set-cookie"]}return e})}};var c=/^\d+\.\d+\.\d+\.\d+$/,u=/^(.*)(:\d+)$/}});