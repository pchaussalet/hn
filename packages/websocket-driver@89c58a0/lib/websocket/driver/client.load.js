montageDefine("89c58a0","lib/websocket/driver/client",{dependencies:["crypto","url","util","../http_parser","./base","./hybi","./proxy"],factory:function(e,t,n){"use strict";var r=e("crypto"),i=e("url"),a=e("util"),o=e("../http_parser"),s=e("./base"),l=e("./hybi"),c=e("./proxy"),u=function(e,t){this.version="hybi-13",l.call(this,null,e,t),this.readyState=-1,this._key=u.generateKey(),this._accept=l.generateAccept(this._key),this._http=new o("response");var n=i.parse(this.url),r=n.auth&&new Buffer(n.auth,"utf8").toString("base64");this._pathname=(n.pathname||"/")+(n.search||""),this._headers.set("Host",n.host),this._headers.set("Upgrade","websocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Key",this._key),this._headers.set("Sec-WebSocket-Version","13"),this._protocols.length>0&&this._headers.set("Sec-WebSocket-Protocol",this._protocols.join(", ")),r&&this._headers.set("Authorization","Basic "+r)};a.inherits(u,l),u.generateKey=function(){return r.randomBytes(16).toString("base64")};var h={proxy:function(e,t){return new c(this,e,t)},start:function(){return-1!==this.readyState?!1:(this._write(this._handshakeRequest()),this.readyState=0,!0)},parse:function(e){return this.readyState>0?l.prototype.parse.call(this,e):(this._http.parse(e),this._http.isComplete()&&(this._validateHandshake(),3!==this.readyState&&(this._open(),this.parse(this._http.body))),void 0)},_handshakeRequest:function(){var e=this._extensions.generateOffer();e&&this._headers.set("Sec-WebSocket-Extensions",e);var t="GET "+this._pathname+" HTTP/1.1",n=[t,""+this._headers,""];return new Buffer(n.join("\r\n"),"utf8")},_failHandshake:function(e){e="Error during WebSocket handshake: "+e,this.emit("error",Error(e)),this.readyState=3,this.emit("close",new s.CloseEvent(this.ERRORS.protocol_error,e))},_validateHandshake:function(){if(this.statusCode=this._http.statusCode,this.headers=this._http.headers,101!==this._http.statusCode)return this._failHandshake("Unexpected response code: "+this._http.statusCode);var e=this._http.headers,t=e.upgrade||"",n=e.connection||"",r=e["sec-websocket-accept"]||"",i=e["sec-websocket-protocol"]||"";if(""===t)return this._failHandshake("'Upgrade' header is missing");if("websocket"!==t.toLowerCase())return this._failHandshake("'Upgrade' header value is not 'WebSocket'");if(""===n)return this._failHandshake("'Connection' header is missing");if("upgrade"!==n.toLowerCase())return this._failHandshake("'Connection' header value is not 'Upgrade'");if(r!==this._accept)return this._failHandshake("Sec-WebSocket-Accept mismatch");if(this.protocol=null,""!==i){if(0>this._protocols.indexOf(i))return this._failHandshake("Sec-WebSocket-Protocol mismatch");this.protocol=i}try{this._extensions.activate(this.headers["sec-websocket-extensions"])}catch(a){return this._failHandshake(a.message)}}};for(var d in h)u.prototype[d]=h[d];n.exports=u}});