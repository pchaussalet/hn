montageDefine("89c58a0","lib/websocket/driver/draft75",{dependencies:["./base","util"],factory:function(e,t,n){"use strict";var r=e("./base"),i=e("util"),a=function(){r.apply(this,arguments),this._stage=0,this.version="hixie-75",this._headers.set("Upgrade","WebSocket"),this._headers.set("Connection","Upgrade"),this._headers.set("WebSocket-Origin",this._request.headers.origin),this._headers.set("WebSocket-Location",this.url)};i.inherits(a,r);var o={close:function(){return 3===this.readyState?!1:(this.readyState=3,this.emit("close",new r.CloseEvent(null,null)),!0)},parse:function(e){if(!(this.readyState>1))for(var t,n,i,a=0,o=e.length;o>a;a++)switch(t=e[a],this._stage){case-1:this._body.push(t),this._sendHandshakeBody();break;case 0:this._parseLeadingByte(t);break;case 1:if(i=127&t,this._length=i+128*this._length,this._closing&&0===this._length)return this.close();128!==(128&t)&&(0===this._length?this._stage=0:(this._skipped=0,this._stage=2));break;case 2:if(255===t)n=new Buffer(this._buffer).toString("utf8",0,this._buffer.length),this.emit("message",new r.MessageEvent(n)),this._stage=0;else if(this._length)this._skipped+=1,this._skipped===this._length&&(this._stage=0);else if(this._buffer.push(t),this._buffer.length>this._maxLength)return this.close()}},frame:function(e){if(0===this.readyState)return this._queue([e]);if(this.readyState>1)return!1;var t=new Buffer(e,"utf8"),n=new Buffer(t.length+2);return n[0]=0,n[t.length+1]=255,t.copy(n,1),this._write(n),!0},_handshakeResponse:function(){var e="HTTP/1.1 101 Web Socket Protocol Handshake",t=[e,""+this._headers,""];return new Buffer(t.join("\r\n"),"utf8")},_parseLeadingByte:function(e){128===(128&e)?(this._length=0,this._stage=1):(delete this._length,delete this._skipped,this._buffer=[],this._stage=2)}};for(var s in o)a.prototype[s]=o[s];n.exports=a}});