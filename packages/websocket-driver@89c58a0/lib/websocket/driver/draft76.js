"use strict";var Base=require("./base"),Draft75=require("./draft75"),crypto=require("crypto"),util=require("util"),numberFromKey=function(e){return parseInt(e.match(/[0-9]/g).join(""),10)},spacesInKey=function(e){return e.match(/ /g).length},bigEndian=function(e){var t="";return[24,16,8,0].forEach(function(n){t+=String.fromCharCode(255&e>>n)}),t},Draft76=function(){Draft75.apply(this,arguments),this._stage=-1,this._body=[],this.version="hixie-76",this._headers.clear(),this._headers.set("Upgrade","WebSocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Origin",this._request.headers.origin),this._headers.set("Sec-WebSocket-Location",this.url)};util.inherits(Draft76,Draft75);var instance={BODY_SIZE:8,start:function(){return Draft75.prototype.start.call(this)?(this._started=!0,this._sendHandshakeBody(),!0):!1},close:function(){return 3===this.readyState?!1:(this._write(new Buffer([255,0])),this.readyState=3,this.emit("close",new Base.CloseEvent(null,null)),!0)},_handshakeResponse:function(){var e="HTTP/1.1 101 WebSocket Protocol Handshake",t=[e,""+this._headers,""];return new Buffer(t.join("\r\n"),"binary")},_handshakeSignature:function(){if(this._body.length<this.BODY_SIZE)return null;var e=new Buffer(this._body.slice(0,this.BODY_SIZE)),t=this._request.headers,n=t["sec-websocket-key1"],r=numberFromKey(n)/spacesInKey(n),i=t["sec-websocket-key2"],a=numberFromKey(i)/spacesInKey(i),o=crypto.createHash("md5");return o.update(bigEndian(r)),o.update(bigEndian(a)),o.update(e.toString("binary")),new Buffer(o.digest("binary"),"binary")},_sendHandshakeBody:function(){if(this._started){var e=this._handshakeSignature();e&&(this._write(e),this._stage=0,this._open(),this._body.length>this.BODY_SIZE&&this.parse(this._body.slice(this.BODY_SIZE)))}},_parseLeadingByte:function(e){return 255!==e?Draft75.prototype._parseLeadingByte.call(this,e):(this._closing=!0,this._length=0,this._stage=1,void 0)}};for(var key in instance)Draft76.prototype[key]=instance[key];module.exports=Draft76;