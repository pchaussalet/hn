montageDefine("89c58a0","lib/websocket/driver/draft76",{dependencies:["./base","./draft75","crypto","util"],factory:function(e,t,n){"use strict";var r=e("./base"),i=e("./draft75"),a=e("crypto"),o=e("util"),s=function(e){return parseInt(e.match(/[0-9]/g).join(""),10)},l=function(e){return e.match(/ /g).length},c=function(e){var t="";return[24,16,8,0].forEach(function(n){t+=String.fromCharCode(255&e>>n)}),t},u=function(){i.apply(this,arguments),this._stage=-1,this._body=[],this.version="hixie-76",this._headers.clear(),this._headers.set("Upgrade","WebSocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Origin",this._request.headers.origin),this._headers.set("Sec-WebSocket-Location",this.url)};o.inherits(u,i);var h={BODY_SIZE:8,start:function(){return i.prototype.start.call(this)?(this._started=!0,this._sendHandshakeBody(),!0):!1},close:function(){return 3===this.readyState?!1:(this._write(new Buffer([255,0])),this.readyState=3,this.emit("close",new r.CloseEvent(null,null)),!0)},_handshakeResponse:function(){var e="HTTP/1.1 101 WebSocket Protocol Handshake",t=[e,""+this._headers,""];return new Buffer(t.join("\r\n"),"binary")},_handshakeSignature:function(){if(this._body.length<this.BODY_SIZE)return null;var e=new Buffer(this._body.slice(0,this.BODY_SIZE)),t=this._request.headers,n=t["sec-websocket-key1"],r=s(n)/l(n),i=t["sec-websocket-key2"],o=s(i)/l(i),u=a.createHash("md5");return u.update(c(r)),u.update(c(o)),u.update(e.toString("binary")),new Buffer(u.digest("binary"),"binary")},_sendHandshakeBody:function(){if(this._started){var e=this._handshakeSignature();e&&(this._write(e),this._stage=0,this._open(),this._body.length>this.BODY_SIZE&&this.parse(this._body.slice(this.BODY_SIZE)))}},_parseLeadingByte:function(e){return 255!==e?i.prototype._parseLeadingByte.call(this,e):(this._closing=!0,this._length=0,this._stage=1,void 0)}};for(var d in h)u.prototype[d]=h[d];n.exports=u}});