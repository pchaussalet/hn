"use strict";var crypto=require("crypto"),util=require("util"),Extensions=require("websocket-extensions"),Base=require("./base"),Frame=require("./hybi/frame"),Message=require("./hybi/message"),Reader=require("./hybi/stream_reader"),Hybi=function(){if(Base.apply(this,arguments),this._extensions=new Extensions,this._reader=new Reader,this._stage=0,this._masking=this._options.masking,this._protocols=this._options.protocols||[],this._requireMasking=this._options.requireMasking,this._pingCallbacks={},"string"==typeof this._protocols&&(this._protocols=this._protocols.split(/ *, */)),this._request){var e=this._request.headers["sec-websocket-key"],t=this._request.headers["sec-websocket-protocol"],n=this._request.headers["sec-websocket-version"],r=this._protocols;this._headers.set("Upgrade","websocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Accept",Hybi.generateAccept(e)),void 0!==t&&("string"==typeof t&&(t=t.split(/ *, */)),this.protocol=t.filter(function(e){return r.indexOf(e)>=0})[0],this.protocol&&this._headers.set("Sec-WebSocket-Protocol",this.protocol)),this.version="hybi-"+n}};util.inherits(Hybi,Base),Hybi.mask=function(e,t,n){if(!t||0===t.length)return e;n=n||0;for(var r=0,i=e.length-n;i>r;r++)e[n+r]=e[n+r]^t[r%4];return e},Hybi.generateAccept=function(e){var t=crypto.createHash("sha1");return t.update(e+Hybi.GUID),t.digest("base64")},Hybi.GUID="258EAFA5-E914-47DA-95CA-C5AB0DC85B11";var instance={BYTE:255,FIN:128,MASK:128,RSV1:64,RSV2:32,RSV3:16,OPCODE:15,LENGTH:127,OPCODES:{continuation:0,text:1,binary:2,close:8,ping:9,pong:10},OPCODE_CODES:[0,1,2,8,9,10],MESSAGE_OPCODES:[0,1,2],OPENING_OPCODES:[1,2],TWO_POWERS:[0,1,2,3,4,5,6,7].map(function(e){return Math.pow(2,8*e)}),ERRORS:{normal_closure:1e3,going_away:1001,protocol_error:1002,unacceptable:1003,encoding_error:1007,policy_violation:1008,too_large:1009,extension_error:1010,unexpected_condition:1011},ERROR_CODES:[1e3,1001,1002,1003,1007,1008,1009,1010,1011],MIN_RESERVED_ERROR:3e3,MAX_RESERVED_ERROR:4999,UTF8_MATCH:/^([\x00-\x7F]|[\xC2-\xDF][\x80-\xBF]|\xE0[\xA0-\xBF][\x80-\xBF]|[\xE1-\xEC\xEE\xEF][\x80-\xBF]{2}|\xED[\x80-\x9F][\x80-\xBF]|\xF0[\x90-\xBF][\x80-\xBF]{2}|[\xF1-\xF3][\x80-\xBF]{3}|\xF4[\x80-\x8F][\x80-\xBF]{2})*$/,addExtension:function(e){return this._extensions.add(e),!0},parse:function(e){this._reader.put(e);for(var t=!0;t;)switch(this._stage){case 0:t=this._reader.read(1),t&&this._parseOpcode(t[0]);break;case 1:t=this._reader.read(1),t&&this._parseLength(t[0]);break;case 2:t=this._reader.read(this._frame.lengthBytes),t&&this._parseExtendedLength(t);break;case 3:t=this._reader.read(4),t&&(this._frame.maskingKey=t,this._stage=4);break;case 4:t=this._reader.read(this._frame.length),t&&(this._emitFrame(t),this._stage=0);break;default:t=null}},text:function(e){return this.readyState>1?!1:this.frame(e,"text")},binary:function(e){return this.readyState>1?!1:this.frame(e,"binary")},ping:function(e,t){return this.readyState>1?!1:(e=e||"",t&&(this._pingCallbacks[e]=t),this.frame(e,"ping"))},close:function(e,t){return e=e||"",t=t||this.ERRORS.normal_closure,0>=this.readyState?(this.readyState=3,this.emit("close",new Base.CloseEvent(t,e)),!0):1===this.readyState?(this.readyState=2,this._extensions.close(function(){this.frame(e,"close",t)},this),!0):!1},frame:function(e,t,n){if(0>=this.readyState)return this._queue([e,t,n]);if(this.readyState>2)return!1;e instanceof Array&&(e=new Buffer(e));var r,i,a=new Message,o="string"==typeof e;a.rsv1=a.rsv2=a.rsv3=!1,a.opcode=this.OPCODES[t||(o?"text":"binary")],r=o?new Buffer(e,"utf8"):e,n&&(i=r,r=new Buffer(2+i.length),r[0]=~~(n/256)&this.BYTE,r[1]=n&this.BYTE,i.copy(r,2)),a.data=r;var s=function(e){var t=new Frame;t.final=!0,t.rsv1=e.rsv1,t.rsv2=e.rsv2,t.rsv3=e.rsv3,t.opcode=e.opcode,t.masked=!!this._masking,t.length=e.data.length,t.payload=e.data,t.masked&&(t.maskingKey=crypto.randomBytes(4)),this._sendFrame(t)};return this.MESSAGE_OPCODES.indexOf(a.opcode)>=0?this._extensions.processOutgoingMessage(a,function(e,t){return e?this._fail("extension_error",e.message):(s.call(this,t),void 0)},this):s.call(this,a),!0},_sendFrame:function(e){var t=e.length,n=125>=t?2:65535>=t?4:10,r=n+(e.masked?4:0),i=new Buffer(r+t),a=this.BYTE,o=e.masked?this.MASK:0;i[0]=(e.final?this.FIN:0)|(e.rsv1?this.RSV1:0)|(e.rsv2?this.RSV2:0)|(e.rsv3?this.RSV3:0)|e.opcode,125>=t?i[1]=o|t:65535>=t?(i[1]=126|o,i[2]=~~(t/256),i[3]=t&a):(i[1]=127|o,i[2]=~~(t/Math.pow(2,56))&a,i[3]=~~(t/Math.pow(2,48))&a,i[4]=~~(t/Math.pow(2,40))&a,i[5]=~~(t/Math.pow(2,32))&a,i[6]=~~(t/Math.pow(2,24))&a,i[7]=~~(t/Math.pow(2,16))&a,i[8]=~~(t/Math.pow(2,8))&a,i[9]=t&a),e.masked?(e.maskingKey.copy(i,n),Hybi.mask(e.payload,e.maskingKey).copy(i,r)):e.payload.copy(i,r),this._write(i)},_handshakeResponse:function(){var e=this._extensions.generateResponse(this._request.headers["sec-websocket-extensions"]);e&&this._headers.set("Sec-WebSocket-Extensions",e);var t="HTTP/1.1 101 Switching Protocols",n=[t,""+this._headers,""];return new Buffer(n.join("\r\n"),"utf8")},_shutdown:function(e,t){delete this._frame,delete this._message,this.readyState=2,this._stage=5,this._extensions.close(function(){this.frame(t,"close",e),this.readyState=3,this.emit("close",new Base.CloseEvent(e,t))},this)},_fail:function(e,t){this.readyState>1||(this.emit("error",Error(t)),this._shutdown(this.ERRORS[e],t))},_parseOpcode:function(e){var t=[this.RSV1,this.RSV2,this.RSV3].map(function(t){return(e&t)===t}),n=this._frame=new Frame;return n.final=(e&this.FIN)===this.FIN,n.rsv1=t[0],n.rsv2=t[1],n.rsv3=t[2],n.opcode=e&this.OPCODE,this._extensions.validFrameRsv(n)?0>this.OPCODE_CODES.indexOf(n.opcode)?this._fail("protocol_error","Unrecognized frame opcode: "+n.opcode):0>this.MESSAGE_OPCODES.indexOf(n.opcode)&&!n.final?this._fail("protocol_error","Received fragmented control frame: opcode = "+n.opcode):this._message&&this.OPENING_OPCODES.indexOf(n.opcode)>=0?this._fail("protocol_error","Received new data frame but previous continuous frame is unfinished"):(this._stage=1,void 0):this._fail("protocol_error","One or more reserved bits are on: reserved1 = "+(n.rsv1?1:0)+", reserved2 = "+(n.rsv2?1:0)+", reserved3 = "+(n.rsv3?1:0))},_parseLength:function(e){var t=this._frame;if(t.masked=(e&this.MASK)===this.MASK,this._requireMasking&&!t.masked)return this._fail("unacceptable","Received unmasked frame but masking is required");if(t.length=e&this.LENGTH,t.length>=0&&125>=t.length){if(!this._checkFrameLength())return;this._stage=t.masked?3:4}else t.lengthBytes=126===t.length?2:8,this._stage=2},_parseExtendedLength:function(e){var t=this._frame;return t.length=this._getInteger(e),0>this.MESSAGE_OPCODES.indexOf(t.opcode)&&t.length>125?this._fail("protocol_error","Received control frame having too long payload: "+t.length):(this._checkFrameLength()&&(this._stage=t.masked?3:4),void 0)},_checkFrameLength:function(){var e=this._message?this._message.length:0;return e+this._frame.length>this._maxLength?(this._fail("too_large","WebSocket frame length too large"),!1):!0},_emitFrame:function(e){var t,n,r,i,a,o=this._frame,s=o.payload=Hybi.mask(e,o.maskingKey),l=o.opcode;if(delete this._frame,l===this.OPCODES.continuation){if(!this._message)return this._fail("protocol_error","Received unexpected continuation frame");this._message.pushFrame(o)}return(l===this.OPCODES.text||l===this.OPCODES.binary)&&(this._message=new Message,this._message.pushFrame(o)),o.final&&this.MESSAGE_OPCODES.indexOf(l)>=0?this._emitMessage(this._message):(l===this.OPCODES.close&&(n=s.length>=2?256*s[0]+s[1]:null,r=s.length>2?this._encode(s.slice(2)):null,0!==s.length&&!(null!==n&&n>=this.MIN_RESERVED_ERROR&&this.MAX_RESERVED_ERROR>=n)&&0>this.ERROR_CODES.indexOf(n)&&(n=this.ERRORS.protocol_error),(s.length>125||s.length>2&&!r)&&(n=this.ERRORS.protocol_error),this._shutdown(n,r||"")),l===this.OPCODES.ping&&this.frame(s,"pong"),l===this.OPCODES.pong&&(i=this._pingCallbacks,t=this._encode(s),a=i[t],delete i[t],a&&a()),void 0)},_emitMessage:function(e){var e=this._message;e.read(),delete this._message,this._extensions.processIncomingMessage(e,function(e,t){if(e)return this._fail("extension_error",e.message);var n=t.data;return t.opcode===this.OPCODES.text&&(n=this._encode(n)),null===n?this._fail("encoding_error","Could not decode a text frame as UTF-8"):(this.emit("message",new Base.MessageEvent(n)),void 0)},this)},_encode:function(e){try{var t=e.toString("binary",0,e.length);if(!this.UTF8_MATCH.test(t))return null}catch(n){}return e.toString("utf8",0,e.length)},_getInteger:function(e){for(var t=0,n=0,r=e.length;r>n;n++)t+=e[n]*this.TWO_POWERS[r-1-n];return t}};for(var key in instance)Hybi.prototype[key]=instance[key];module.exports=Hybi;