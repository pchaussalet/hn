"use strict";var Stream=require("stream").Stream,url=require("url"),util=require("util"),Headers=require("./headers"),HttpParser=require("../http_parser"),PORTS={"ws:":80,"wss:":443},Proxy=function(e,t,n){this._client=e,this._http=new HttpParser("response"),this._origin="object"==typeof e.url?e.url:url.parse(e.url),this._url="object"==typeof t?t:url.parse(t),this._options=n||{},this._state=0,this.readable=this.writable=!0,this._paused=!1,this._headers=new Headers,this._headers.set("Host",this._origin.host),this._headers.set("Connection","keep-alive"),this._headers.set("Proxy-Connection","keep-alive");var r=this._url.auth&&new Buffer(this._url.auth,"utf8").toString("base64");r&&this._headers.set("Proxy-Authorization","Basic "+r)};util.inherits(Proxy,Stream);var instance={setHeader:function(e,t){return 0!==this._state?!1:(this._headers.set(e,t),!0)},start:function(){if(0!==this._state)return!1;this._state=1;var e=this._origin,t=e.port||PORTS[e.protocol],n="CONNECT "+e.hostname+":"+t+" HTTP/1.1",r=[n,""+this._headers,""];return this.emit("data",new Buffer(r.join("\r\n"),"utf8")),!0},pause:function(){this._paused=!0},resume:function(){this._paused=!1,this.emit("drain")},write:function(e){if(!this.writable)return!1;if(this._http.parse(e),!this._http.isComplete())return!this._paused;if(this.statusCode=this._http.statusCode,this.headers=this._http.headers,200===this.statusCode)this.emit("connect");else{var t="Can't establish a connection to the server at "+this._origin.href;this.emit("error",Error(t))}return this.end(),!this._paused},end:function(e){this.writable&&(void 0!==e&&this.write(e),this.readable=this.writable=!1,this.emit("close"),this.emit("end"))},destroy:function(){this.end()}};for(var key in instance)Proxy.prototype[key]=instance[key];module.exports=Proxy;