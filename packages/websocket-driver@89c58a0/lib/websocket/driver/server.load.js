montageDefine("89c58a0","lib/websocket/driver/server",{dependencies:["util","../http_parser","./base","./draft75","./draft76","./hybi"],factory:function(e,t,n){"use strict";var r=e("util"),i=e("../http_parser"),a=e("./base"),o=e("./draft75"),s=e("./draft76"),l=e("./hybi"),c=function(e){a.call(this,null,null,e),this._http=new i("request")};r.inherits(c,a);var u={EVENTS:["open","message","error","close"],_bindEventListeners:function(){this.messages.on("error",function(){}),this.on("error",function(){})},parse:function(e){if(this._delegate)return this._delegate.parse(e);if(this._http.parse(e),this._http.isComplete()){this.method=this._http.method,this.url=this._http.url,this.headers=this._http.headers,this.body=this._http.body;var t=this;this._delegate=c.http(this,this._options),this._delegate.messages=this.messages,this._delegate.io=this.io,this._open(),this.EVENTS.forEach(function(e){this._delegate.on(e,function(n){t.emit(e,n)})},this),this.protocol=this._delegate.protocol,this.version=this._delegate.version,this.parse(this._http.body),this.emit("connect",new a.ConnectEvent)}},_open:function(){this.__queue.forEach(function(e){this._delegate[e[0]].apply(this._delegate,e[1])},this),this.__queue=[]}};["addExtension","setHeader","start","frame","text","binary","ping","close"].forEach(function(e){u[e]=function(){return this._delegate?this._delegate[e].apply(this._delegate,arguments):(this.__queue.push([e,arguments]),!0)}});for(var h in u)c.prototype[h]=u[h];c.isSecureRequest=function(e){if(e.connection&&void 0!==e.connection.authorized)return!0;if(e.socket&&e.socket.secure)return!0;var t=e.headers;return t?"on"===t.https?!0:"on"===t["x-forwarded-ssl"]?!0:"https"===t["x-forwarded-scheme"]?!0:"https"===t["x-forwarded-proto"]?!0:!1:!1},c.determineUrl=function(e){var t=this.isSecureRequest(e)?"wss:":"ws:";return t+"//"+e.headers.host+e.url},c.http=function(e,t){t=t||{},void 0===t.requireMasking&&(t.requireMasking=!0);var n=e.headers,r=this.determineUrl(e);return n["sec-websocket-version"]?new l(e,r,t):n["sec-websocket-key1"]?new s(e,r,t):new o(e,r,t)},n.exports=c}});