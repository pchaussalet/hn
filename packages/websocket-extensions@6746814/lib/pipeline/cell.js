"use strict";var Functor=require("./functor"),Pledge=require("./pledge"),Cell=function(e){this._ext=e[0],this._session=e[1],this._functors={incoming:new Functor(this._session,"processIncomingMessage"),outgoing:new Functor(this._session,"processOutgoingMessage")}};Cell.prototype.pending=function(e){this._functors[e].pending+=1},Cell.prototype.incoming=function(e,t,n,i){this._exec("incoming",e,t,n,i)},Cell.prototype.outgoing=function(e,t,n,i){this._exec("outgoing",e,t,n,i)},Cell.prototype.close=function(){return this._closed=this._closed||new Pledge,this._doClose(),this._closed},Cell.prototype._exec=function(e,t,n,i,r){this._functors[e].call(t,n,function(e,t){e&&(e.message=this._ext.name+": "+e.message),i.call(r,e,t),this._doClose()},this)},Cell.prototype._doClose=function(){var e=this._functors.incoming,t=this._functors.outgoing;this._closed&&0===e.pending+t.pending&&(this._session&&this._session.close(),this._session=null,this._closed.done())},module.exports=Cell;