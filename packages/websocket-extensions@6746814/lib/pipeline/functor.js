"use strict";var RingBuffer=require("./ring_buffer"),Functor=function(e,t){this._session=e,this._method=t,this._queue=new RingBuffer(Functor.QUEUE_SIZE),this._stopped=!1,this.pending=0};Functor.QUEUE_SIZE=8,Functor.prototype.call=function(e,t,n,i){if(!this._stopped){var r={error:e,message:t,callback:n,context:i,done:!1},a=!1,o=this;return this._queue.push(r),r.error?(r.done=!0,this._stop(),this._flushQueue()):(this._session[this._method](t,function(e,t){a^(a=!0)&&(e?(o._stop(),r.error=e,r.message=null):r.message=t,r.done=!0,o._flushQueue())}),void 0)}},Functor.prototype._stop=function(){this.pending=this._queue.length,this._stopped=!0},Functor.prototype._flushQueue=function(){for(var e,t=this._queue;t.length>0&&t.peek().done;)this.pending-=1,e=t.shift(),e.callback.call(e.context,e.error,e.message)},module.exports=Functor;