"use strict";var Cell=require("./cell"),Pledge=require("./pledge"),Pipeline=function(e){this._cells=e.map(function(e){return new Cell(e)}),this._stopped={incoming:!1,outgoing:!1}};Pipeline.prototype.processIncomingMessage=function(e,t,n){this._stopped.incoming||this._loop("incoming",this._cells.length-1,-1,-1,e,t,n)},Pipeline.prototype.processOutgoingMessage=function(e,t,n){this._stopped.outgoing||this._loop("outgoing",0,this._cells.length,1,e,t,n)},Pipeline.prototype.close=function(e,t){this._stopped={incoming:!0,outgoing:!0};var n=this._cells.map(function(e){return e.close()});e&&Pledge.all(n).then(function(){e.call(t)})},Pipeline.prototype._loop=function(e,t,n,i,r,a,o){for(var s=this._cells,l=s.length,c=this;l--;)s[l].pending(e);var u=function(t,r,l){return t===n?a.call(o,r,l):(s[t][e](r,l,function(n,r){n&&(c._stopped[e]=!0),u(t+i,n,r)}),void 0)};u(t,null,r)},module.exports=Pipeline;