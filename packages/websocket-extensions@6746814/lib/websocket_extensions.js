"use strict";var Parser=require("./parser"),Pipeline=require("./pipeline"),Extensions=function(){this._rsv1=this._rsv2=this._rsv3=null,this._byName={},this._inOrder=[],this._sessions=[],this._index={}};Extensions.MESSAGE_OPCODES=[1,2];var instance={add:function(e){if("string"!=typeof e.name)throw new TypeError("extension.name must be a string");if("permessage"!==e.type)throw new TypeError('extension.type must be "permessage"');if("boolean"!=typeof e.rsv1)throw new TypeError("extension.rsv1 must be true or false");if("boolean"!=typeof e.rsv2)throw new TypeError("extension.rsv2 must be true or false");if("boolean"!=typeof e.rsv3)throw new TypeError("extension.rsv3 must be true or false");if(this._byName.hasOwnProperty(e.name))throw new TypeError('An extension with name "'+e.name+'" is already registered');this._byName[e.name]=e,this._inOrder.push(e)},generateOffer:function(){var e=[],t=[],n={};return this._inOrder.forEach(function(i){var r=i.createClientSession();if(r){var a=[i,r];e.push(a),n[i.name]=a;var o=r.generateOffer();o=o?[].concat(o):[],o.forEach(function(e){t.push(Parser.serializeParams(i.name,e))},this)}},this),this._sessions=e,this._index=n,t.length>0?t.join(", "):null},activate:function(e){var t=Parser.parseHeader(e),n=[];t.eachOffer(function(e,t){var i=this._index[e];if(!i)throw Error('Server sent an extension response for unknown extension "'+e+'"');var r=i[0],a=i[1],o=this._reserved(r);if(o)throw Error("Server sent two extension responses that use the RSV"+o[0]+' bit: "'+o[1]+'" and "'+r.name+'"');if(a.activate(t)!==!0)throw Error("Server sent unacceptable extension parameters: "+Parser.serializeParams(e,t));this._reserve(r),n.push(i)},this),this._sessions=n,this._pipeline=new Pipeline(n)},generateResponse:function(e){var t=Parser.parseHeader(e),n=[],i=[];return this._inOrder.forEach(function(e){var r=t.byName(e.name);if(0!==r.length&&!this._reserved(e)){var a=e.createServerSession(r);a&&(this._reserve(e),n.push([e,a]),i.push(Parser.serializeParams(e.name,a.generateResponse())))}},this),this._sessions=n,this._pipeline=new Pipeline(n),i.length>0?i.join(", "):null},validFrameRsv:function(e){var t,n={rsv1:!1,rsv2:!1,rsv3:!1};if(Extensions.MESSAGE_OPCODES.indexOf(e.opcode)>=0)for(var i=0,r=this._sessions.length;r>i;i++)t=this._sessions[i][0],n.rsv1=n.rsv1||t.rsv1,n.rsv2=n.rsv2||t.rsv2,n.rsv3=n.rsv3||t.rsv3;return!(!n.rsv1&&e.rsv1||!n.rsv2&&e.rsv2||!n.rsv3&&e.rsv3)},processIncomingMessage:function(e,t,n){this._pipeline.processIncomingMessage(e,t,n)},processOutgoingMessage:function(e,t,n){this._pipeline.processOutgoingMessage(e,t,n)},close:function(e,t){return this._pipeline?(this._pipeline.close(e,t),void 0):e.call(t)},_reserve:function(e){this._rsv1=this._rsv1||e.rsv1&&e.name,this._rsv2=this._rsv2||e.rsv2&&e.name,this._rsv3=this._rsv3||e.rsv3&&e.name},_reserved:function(e){return this._rsv1&&e.rsv1?[1,this._rsv1]:this._rsv2&&e.rsv2?[2,this._rsv2]:this._rsv3&&e.rsv3?[3,this._rsv3]:!1}};for(var key in instance)Extensions.prototype[key]=instance[key];module.exports=Extensions;