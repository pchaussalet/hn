function Node(e,n,t,o){this.content=e,this.depth=t,this.children=n||[],this.nodeType=o,this.depth_helper=Array.apply(null,Array(t))}var Component=require("montage/ui/component").Component,TimeAgoConverter=require("lib/time-ago-converter").TimeAgoConverter,fetchKids=function(e,n,t,o){var r,i=n||0,a=t||10,l=[],c=(o||0)+3,s=(r=e,r=r&&r.content,r&&r.kids);return s&&s.slice(i,i+a).forEach(function(n,t){var o=new Firebase("https://hacker-news.firebaseio.com/v0/item/"+n);(function(e,n){l.push(new Promise(function(t){var o=e.on("value",function(r){var i=r.val(),a=new Node(i,null,n.depth+1,i.type);e.off("value",o),t(a)})}))})(o,e,t)}),s&&s.length-i>a&&l.push(new Promise(function(n){n(new Node({parent:e},null,e.depth,"more-placeholder"))})),Promise.all(l).then(function(n){return n.forEach(function(n){e.children.push(n)}),Promise.all(n.map(function(e){return e&&e.content&&e.content.kids&&e.content.kids.length>0?c+1>e.depth?fetchKids(e,0,null,o):new Promise(function(n){e.children.push(new Node({parent:e},null,e.depth,"more-placeholder")),n()}):void 0}))})};exports.Comments=Component.specialize({constructor:{value:function(){this.super(),this.addPathChangeListener("itemId",this,"_loadStory")}},time_ago_converter:{value:new TimeAgoConverter},handleClick:{value:function(e){var n;if(e.target.component&&(n=e.target.component.nodeData)){n.content.parent.content;var t=n.content.parent.children.length-1,o=n.content.parent.depth;fetchKids(n.content.parent,t,null,o).then(function(){n.content.parent.children.splice(t,1)}),e.stopPropagation(),e.preventDefault()}}},_loadStory:{value:function(){if(!this.itemId)return this.story=null,void 0;var e=new Firebase("https://hacker-news.firebaseio.com/v0/item/"+this.itemId),n=this;new Promise(function(n){var t=e.on("value",function(o){o.val()&&(node=new Node(o.val(),null,0,o.val().type),e.off("value",t),fetchKids(node).then(function(){n(node)}))})}).then(function(e){n.story=e})}},enterDocument:{value:function(e){e&&this.element.addEventListener("click",this,!1)}}});